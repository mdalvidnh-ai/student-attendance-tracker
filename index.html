<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Attendance Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
    <style>
        .active-tab { border-bottom: 4px solid #2196F3; color: #2196F3; }
        .present-bg { background-color: #4CAF50 !important; color: white; }
        .absent-bg { background-color: #F44336 !important; color: white; }
    </style>
</head>
<body class="bg-gray-50 pb-20">

    <header class="bg-[#2196F3] text-white p-4 shadow-md sticky top-0 z-10">
        <h1 class="text-xl font-bold">Attendance Tracker</h1>
        <input type="date" id="datePicker" class="mt-2 p-2 rounded text-black w-full">
    </header>

    <main class="p-4">
        <section id="home-sec" class="tab-content">
            <div id="studentList" class="space-y-3">
                <p class="text-center text-gray-500 mt-10">Upload an Excel file to get started.</p>
            </div>
        </section>

        <section id="stats-sec" class="tab-content hidden">
            <h2 class="text-lg font-bold mb-4">Monthly Statistics</h2>
            <div id="statsResult" class="space-y-4"></div>
        </section>

        <section id="upload-sec" class="tab-content hidden">
            <div class="bg-white p-6 rounded-lg shadow">
                <h2 class="text-lg font-bold mb-2">Upload Student Data</h2>
                <p class="text-sm text-gray-600 mb-4">Upload .xlsx with columns: Roll No, Student Name, Gender</p>
                <input type="file" id="excelInput" accept=".xlsx, .xls" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
            </div>
        </section>
    </main>

    <nav class="fixed bottom-0 w-full bg-white border-t flex justify-around p-2 shadow-lg">
        <button onclick="showTab('home')" id="home-btn" class="p-2 flex flex-col items-center active-tab">
            <span class="text-xs">Home</span>
        </button>
        <button onclick="showTab('stats')" id="stats-btn" class="p-2 flex flex-col items-center">
            <span class="text-xs">Statistics</span>
        </button>
        <button onclick="showTab('upload')" id="upload-btn" class="p-2 flex flex-col items-center">
            <span class="text-xs">Upload</span>
        </button>
    </nav>

    <script>
        // 1. Initialize Database
        const db = new Dexie("AttendanceDB");
        db.version(1).stores({
            students: 'rollNo, name, gender',
            attendance: '++id, [rollNo+date], date, status'
        });

        const datePicker = document.getElementById('datePicker');
        datePicker.valueAsDate = new Date();

        // 2. Excel Upload Logic
        document.getElementById('excelInput').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            const data = await file.arrayBuffer();
            const workbook = XLSX.read(data);
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet);

            const students = json.map(row => ({
                rollNo: String(row['Roll No']),
                name: row['Student Name'],
                gender: row['Gender']
            }));

            await db.students.bulkPut(students);
            alert("Upload Successful!");
            loadAttendanceList();
        });

        // 3. Attendance List Logic
        async function loadAttendanceList() {
            const students = await db.students.toArray();
            const selectedDate = datePicker.value;
            const container = document.getElementById('studentList');
            container.innerHTML = '';

            for (let student of students) {
                const record = await db.attendance.get({rollNo: student.rollNo, date: selectedDate});
                const status = record ? record.status : 'None';
                
                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-4 bg-white rounded shadow border-l-4 " + 
                                (student.gender === 'Male' ? 'border-blue-400' : 'border-pink-400');
                div.innerHTML = `
                    <div>
                        <div class="font-bold">${student.name}</div>
                        <div class="text-xs text-gray-500">Roll: ${student.rollNo}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="mark('${student.rollNo}', 'Present')" class="px-3 py-1 rounded text-sm ${status === 'Present' ? 'present-bg' : 'bg-gray-100'}">P</button>
                        <button onclick="mark('${student.rollNo}', 'Absent')" class="px-3 py-1 rounded text-sm ${status === 'Absent' ? 'absent-bg' : 'bg-gray-100'}">A</button>
                    </div>
                `;
                container.appendChild(div);
            }
        }

        async function mark(rollNo, status) {
            const date = datePicker.value;
            await db.attendance.put({rollNo, date, status});
            loadAttendanceList();
        }

        // 4. Statistics Logic
        async function calculateStats() {
            const date = new Date(datePicker.value);
            const month = date.getMonth();
            const year = date.getFullYear();
            
            const students = await db.students.toArray();
            const attendance = await db.attendance.filter(a => {
                const d = new Date(a.date);
                return d.getMonth() === month && d.getFullYear() === year;
            }).toArray();

            const boys = students.filter(s => s.gender === 'Male');
            const girls = students.filter(s => s.gender === 'Female');

            const getStat = (group) => {
                const groupRolls = group.map(s => s.rollNo);
                const records = attendance.filter(a => groupRolls.includes(a.rollNo));
                const present = records.filter(a => a.status === 'Present').length;
                const absent = records.filter(a => a.status === 'Absent').length;
                return { present, absent };
            };

            const bStats = getStat(boys);
            const gStats = getStat(girls);

            document.getElementById('statsResult').innerHTML = `
                <div class="bg-blue-50 p-4 rounded border-l-4 border-blue-500">
                    <h3 class="font-bold text-blue-800">BOYS STATISTICS</h3>
                    <p>Total Present: ${bStats.present}</p>
                    <p>Total Absent: ${bStats.absent}</p>
                </div>
                <div class="bg-pink-50 p-4 rounded border-l-4 border-pink-500">
                    <h3 class="font-bold text-pink-800">GIRLS STATISTICS</h3>
                    <p>Total Present: ${gStats.present}</p>
                    <p>Total Absent: ${gStats.absent}</p>
                </div>
            `;
        }

        // 5. Navigation
        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-tab'));
            document.getElementById(tab + '-sec').classList.remove('hidden');
            document.getElementById(tab + '-btn').classList.add('active-tab');
            if(tab === 'stats') calculateStats();
            if(tab === 'home') loadAttendanceList();
        }

        datePicker.addEventListener('change', loadAttendanceList);
        loadAttendanceList();
    </script>
</body>
</html>
