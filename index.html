<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAT Tracker - Full Pro</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
    <style>
        .active-tab { color: #2196F3; border-bottom: 4px solid #2196F3; }
        .present-active { background-color: #4CAF50 !important; color: white; border-color: #4CAF50; }
        .absent-active { background-color: #F44336 !important; color: white; border-color: #F44336; }
        #toast { visibility: hidden; background: #333; color: white; padding: 12px 24px; position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); border-radius: 50px; z-index: 1000; }
        #toast.show { visibility: visible; }
    </style>
</head>
<body class="bg-gray-100 pb-24 font-sans">

    <header class="bg-[#2196F3] text-white p-4 sticky top-0 z-50 shadow-md">
        <div class="flex justify-between items-center mb-3">
            <h1 class="text-xl font-black italic">SAT PRO</h1>
            <input type="date" id="datePicker" class="text-black p-1 rounded text-sm outline-none">
        </div>
        <input type="text" id="studentSearch" placeholder="Find student by name..." class="w-full p-2 rounded-lg text-black text-sm" oninput="loadAttendanceList()">
    </header>

    <main class="p-4 max-w-2xl mx-auto">
        <section id="home-sec" class="tab-content">
            <div class="bg-white p-3 mb-4 rounded-xl flex justify-between items-center shadow-sm">
                <span class="text-[10px] font-bold text-gray-400">TAP 'A' TO MARK ABSENT</span>
                <button onclick="saveAllPresent()" class="bg-green-600 text-white px-4 py-1 rounded-full text-[10px] font-bold">SET ALL TO P</button>
            </div>
            <div id="studentList" class="space-y-3"></div>
        </section>

        <section id="stats-sec" class="tab-content hidden">
            <div class="bg-white p-4 rounded-2xl shadow-sm mb-4">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-[10px] font-black text-gray-400 uppercase">Holidays</label>
                    <button onclick="exportToExcel()" class="bg-green-500 text-white px-3 py-1 rounded-lg text-[10px] font-bold">üíæ DOWNLOAD EXCEL</button>
                </div>
                <div class="flex gap-2">
                    <input type="number" id="holidayCount" value="0" class="border-2 border-gray-100 p-2 rounded-xl w-full">
                    <button onclick="saveHolidays()" class="bg-gray-900 text-white px-6 rounded-xl font-bold">SET</button>
                </div>
            </div>

            <div id="statsSummary"></div>

            <div class="mt-6">
                <h3 class="font-bold text-gray-800 mb-2">Absentee History</h3>
                <div id="absenteeLog" class="space-y-2"></div>
            </div>
        </section>

        <section id="upload-sec" class="tab-content hidden">
            <div class="bg-white p-12 rounded-3xl shadow text-center border-2 border-dashed border-gray-200">
                <input type="file" id="excelInput" class="hidden" accept=".xlsx, .xls">
                <label for="excelInput" class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-bold cursor-pointer inline-block">UPLOAD EXCEL</label>
            </div>
        </section>
    </main>

    <div id="toast">Saved!</div>

    <nav class="fixed bottom-0 w-full bg-white border-t flex justify-around py-3 shadow-2xl z-50">
        <button onclick="showTab('home')" id="home-btn" class="flex flex-col items-center active-tab"><span>üìù</span><span class="text-[10px] font-bold">MARK</span></button>
        <button onclick="showTab('stats')" id="stats-btn" class="flex flex-col items-center"><span>üìà</span><span class="text-[10px] font-bold">REPORTS</span></button>
        <button onclick="showTab('upload')" id="upload-btn" class="flex flex-col items-center"><span>‚öôÔ∏è</span><span class="text-[10px] font-bold">UPLOAD</span></button>
    </nav>

    <script>
        const db = new Dexie("SAT_FINAL_V3");
        db.version(1).stores({
            students: 'rollNo, name, gender',
            attendance: '++id, [rollNo+date], date, status',
            settings: 'key'
        });

        const datePicker = document.getElementById('datePicker');
        datePicker.valueAsDate = new Date();

        function showToast(m) {
            const t = document.getElementById("toast");
            t.innerText = m; t.classList.add("show");
            setTimeout(() => t.classList.remove("show"), 2000);
        }

        async function loadAttendanceList() {
            const students = await db.students.toArray();
            const date = datePicker.value;
            const search = document.getElementById('studentSearch').value.toLowerCase();
            const container = document.getElementById('studentList');
            container.innerHTML = '';

            const filtered = students.filter(s => s.name.toLowerCase().includes(search));

            for (let s of filtered) {
                const rec = await db.attendance.get({rollNo: s.rollNo, date: date});
                const status = rec ? rec.status : 'Present';

                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-4 bg-white rounded-xl shadow-sm border-l-8 " + 
                                (s.gender === 'Male' ? 'border-blue-500' : 'border-pink-500');
                div.innerHTML = `
                    <div>
                        <div class="font-bold text-gray-800 uppercase text-sm">${s.name}</div>
                        <div class="text-[10px] text-gray-400 font-bold">ROLL: ${s.rollNo}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="mark('${s.rollNo}', 'Present')" class="w-10 h-10 rounded-lg font-bold border-2 ${status === 'Present' ? 'present-active' : 'bg-gray-50 text-gray-300'}">P</button>
                        <button onclick="mark('${s.rollNo}', 'Absent')" class="w-10 h-10 rounded-lg font-bold border-2 ${status === 'Absent' ? 'absent-active' : 'bg-gray-50 text-gray-300'}">A</button>
                    </div>`;
                container.appendChild(div);
            }
        }

        async function mark(rollNo, status) {
            await db.attendance.put({rollNo, date: datePicker.value, status});
            showToast(`${status} saved`);
            loadAttendanceList();
        }

        async function saveAllPresent() {
            const students = await db.students.toArray();
            for(let s of students) await db.attendance.put({ rollNo: s.rollNo, date: datePicker.value, status: 'Present' });
            showToast("Marked All Present");
            loadAttendanceList();
        }

        async function calculateStats() {
            const monthStr = datePicker.value.substring(0, 7);
            const students = await db.students.toArray();
            const attendance = await db.attendance.filter(a => a.date.startsWith(monthStr)).toArray();
            
            const holData = await db.settings.get(monthStr);
            const holidays = holData ? holData.value : 0;
            const workingDays = new Date(monthStr.split('-')[0], monthStr.split('-')[1], 0).getDate() - holidays;

            const gen = (gender) => {
                const group = students.filter(s => s.gender === gender);
                const rolls = group.map(s => s.rollNo);
                const p = attendance.filter(a => rolls.includes(a.rollNo) && a.status === 'Present').length;
                const totalOpp = group.length * workingDays;
                return {
                    perc: totalOpp > 0 ? ((p / totalOpp) * 100).toFixed(1) : 0,
                    avg: group.length > 0 ? (p / (group.length * workingDays)).toFixed(2) : 0
                };
            };

            const b = gen('Male');
            const g = gen('Female');

            document.getElementById('statsSummary').innerHTML = `
                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-blue-600 text-white p-4 rounded-3xl shadow">
                        <p class="text-[10px] font-bold opacity-60 uppercase">Boys Present</p>
                        <p class="text-3xl font-black">${b.perc}%</p>
                        <p class="text-[10px]">Avg: ${b.avg}</p>
                    </div>
                    <div class="bg-pink-500 text-white p-4 rounded-3xl shadow">
                        <p class="text-[10px] font-bold opacity-60 uppercase">Girls Present</p>
                        <p class="text-3xl font-black">${g.perc}%</p>
                        <p class="text-[10px]">Avg: ${g.avg}</p>
                    </div>
                </div>`;

            const days = [...new Set(attendance.map(a => a.date))].sort().reverse();
            let logHtml = '';
            for (let d of days) {
                const absents = attendance.filter(a => a.date === d && a.status === 'Absent');
                const names = absents.map(a => students.find(s => s.rollNo === a.rollNo)?.name || a.rollNo).join(', ');
                logHtml += `
                    <div class="bg-white p-3 rounded-xl border-l-4 border-red-500 shadow-sm">
                        <div class="flex justify-between text-[11px] font-bold mb-1">
                            <span>${d}</span><span class="text-red-600">${absents.length} ABSENT</span>
                        </div>
                        <p class="text-[10px] text-gray-400">${names || 'Full Presence'}</p>
                    </div>`;
            }
            document.getElementById('absenteeLog').innerHTML = logHtml || '<p class="text-center text-gray-400 py-4">No data.</p>';
        }

        async function exportToExcel() {
            const students = await db.students.toArray();
            const attendance = await db.attendance.toArray();
            
            const data = attendance.map(a => ({
                Date: a.date,
                RollNo: a.rollNo,
                Name: students.find(s => s.rollNo === a.rollNo)?.name || 'Unknown',
                Status: a.status
            }));

            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Attendance_Report");
            XLSX.writeFile(wb, `SAT_Report_${new Date().toLocaleDateString()}.xlsx`);
        }

        async function saveHolidays() {
            const m = datePicker.value.substring(0, 7);
            const v = document.getElementById('holidayCount').value;
            await db.settings.put({key: m, value: parseInt(v)});
            showToast("Holidays Saved");
            calculateStats();
        }

        function showTab(t) {
            document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-tab'));
            document.getElementById(t + '-sec').classList.remove('hidden');
            document.getElementById(t + '-btn').classList.add('active-tab');
            if(t === 'stats') calculateStats();
            if(t === 'home') loadAttendanceList();
        }

        document.getElementById('excelInput').onchange = async (e) => {
            const d = await e.target.files[0].arrayBuffer();
            const workbook = XLSX.read(d);
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const students = json.map(r => ({ rollNo: String(r['Roll No']), name: r['Student Name'], gender: r['Gender'] }));
            await db.students.bulkPut(students);
            showToast("Imported!");
            showTab('home');
        };

        datePicker.onchange = loadAttendanceList;
        loadAttendanceList();
    </script>
</body>
</html>
