<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAT Tracker Final</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
    <style>
        .p-active { background-color: #22c55e !important; color: white; border-color: #16a34a; }
        .a-active { background-color: #ef4444 !important; color: white; border-color: #dc2626; }
        .active-tab { border-bottom: 4px solid white; font-weight: 900; }
    </style>
</head>
<body class="bg-slate-100 pb-20">

    <header class="bg-[#2196F3] text-white p-4 sticky top-0 z-50 shadow-xl">
        <div class="flex justify-between items-center mb-4">
            <h1 class="text-xl font-black italic">SAT PRO</h1>
            <input type="date" id="datePicker" class="text-black p-1 rounded-lg text-sm font-bold outline-none">
        </div>
        
        <div class="grid grid-cols-2 gap-2 mb-2">
            <div class="bg-blue-800/40 p-3 rounded-xl border border-white/20 text-center">
                <p class="text-[10px] uppercase opacity-80">Boys Present</p>
                <p id="countB" class="text-2xl font-black">0</p>
            </div>
            <div class="bg-pink-800/40 p-3 rounded-xl border border-white/20 text-center">
                <p class="text-[10px] uppercase opacity-80">Girls Present</p>
                <p id="countG" class="text-2xl font-black">0</p>
            </div>
        </div>
    </header>

    <main class="p-4 max-w-xl mx-auto">
        <section id="home-sec" class="tab-content">
            <input type="text" id="studentSearch" placeholder="üîç Search by student name..." 
                   class="w-full p-4 mb-4 rounded-2xl shadow-inner border-none outline-none text-sm" oninput="loadList()">
            
            <div id="studentList" class="space-y-3">
                <div class="bg-white p-8 rounded-2xl text-center text-gray-400 border-2 border-dashed">
                    No Students Found. <br> Please go to <b>UPLOAD</b> and add your Excel file.
                </div>
            </div>
        </section>

        <section id="upload-sec" class="tab-content hidden">
            <div class="bg-white p-10 rounded-3xl shadow-xl text-center">
                <div class="text-5xl mb-4">üìÅ</div>
                <h2 class="font-bold text-lg mb-2">Upload Student List</h2>
                <p class="text-xs text-gray-400 mb-6">File must have columns: <br><b>Roll No | Student Name | Gender</b></p>
                <input type="file" id="excelInput" class="hidden" accept=".xlsx, .xls">
                <label for="excelInput" class="bg-blue-600 text-white px-10 py-4 rounded-2xl font-bold cursor-pointer inline-block shadow-lg">Select Excel File</label>
            </div>
        </section>
    </main>

    <nav class="fixed bottom-0 w-full bg-[#2196F3] text-white flex justify-around py-3 shadow-2xl">
        <button onclick="showTab('home')" id="home-btn" class="flex flex-col items-center active-tab">
            <span class="text-xl">üìù</span><span class="text-[10px] font-bold">MARK</span>
        </button>
        <button onclick="showTab('upload')" id="upload-btn" class="flex flex-col items-center">
            <span class="text-xl">‚öôÔ∏è</span><span class="text-[10px] font-bold">UPLOAD</span>
        </button>
    </nav>

    <script>
        const db = new Dexie("SAT_ULTIMATE_V5");
        db.version(1).stores({
            students: 'rollNo, name, gender',
            attendance: '++id, [rollNo+date], date, status'
        });

        const datePicker = document.getElementById('datePicker');
        datePicker.valueAsDate = new Date();

        // 1. Fixed Excel Import with Header Detection
        document.getElementById('excelInput').onchange = async (e) => {
            const data = await e.target.files[0].arrayBuffer();
            const workbook = XLSX.read(data);
            const sheet = workbook.Sheets[workbook.SheetNames[0]];
            const json = XLSX.utils.sheet_to_json(sheet);

            const students = json.map(row => {
                const getVal = (names) => {
                    const key = Object.keys(row).find(k => names.includes(k.trim().toLowerCase()));
                    return key ? row[key] : null;
                };

                return {
                    rollNo: String(getVal(['roll no', 'roll', 'id']) || Math.random()),
                    name: getVal(['student name', 'name', 'fullname']) || "UNKNOWN NAME",
                    gender: getVal(['gender', 'sex']) || "Male"
                };
            });

            await db.students.clear();
            await db.students.bulkPut(students);
            alert(`Success! ${students.length} students loaded.`);
            showTab('home');
        };

        // 2. Load List with Real-Time Counters
        async function loadList() {
            const students = await db.students.toArray();
            const date = datePicker.value;
            const search = document.getElementById('studentSearch').value.toLowerCase();
            const container = document.getElementById('studentList');
            container.innerHTML = '';

            let bCount = 0;
            let gCount = 0;

            const filtered = students.filter(s => s.name.toLowerCase().includes(search));

            for (let s of filtered) {
                const rec = await db.attendance.get({rollNo: s.rollNo, date: date});
                const status = rec ? rec.status : null;

                if (status === 'Present') {
                    if (s.gender.toLowerCase().startsWith('m')) bCount++;
                    else gCount++;
                }

                const card = document.createElement('div');
                card.className = "flex justify-between items-center p-4 bg-white rounded-2xl shadow-sm border-l-8 " + 
                                (s.gender.toLowerCase().startsWith('m') ? 'border-blue-500' : 'border-pink-500');
                card.innerHTML = `
                    <div class="flex-1">
                        <div class="font-black text-slate-800 text-base uppercase leading-tight">${s.name}</div>
                        <div class="text-[10px] text-slate-400 font-bold uppercase">Roll: ${s.rollNo} ‚Ä¢ ${s.gender}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="mark('${s.rollNo}', 'Present')" class="w-12 h-12 rounded-xl font-black border-2 transition-all ${status === 'Present' ? 'p-active scale-110 shadow-lg' : 'bg-slate-50 text-slate-300'}">P</button>
                        <button onclick="mark('${s.rollNo}', 'Absent')" class="w-12 h-12 rounded-xl font-black border-2 transition-all ${status === 'Absent' ? 'a-active scale-110 shadow-lg' : 'bg-slate-50 text-slate-300'}">A</button>
                    </div>`;
                container.appendChild(card);
            }

            document.getElementById('countB').innerText = bCount;
            document.getElementById('countG').innerText = gCount;
        }

        async function mark(rollNo, status) {
            await db.attendance.put({rollNo, date: datePicker.value, status});
            loadList();
        }

        function showTab(t) {
            document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-tab'));
            document.getElementById(t + '-sec').classList.remove('hidden');
            document.getElementById(t + '-btn').classList.add('active-tab');
            if (t === 'home') loadList();
        }

        datePicker.onchange = loadList;
        loadList();
    </script>
</body>
</html>

