<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SAT Tracker Pro</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icon.png" type="image/png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dexie/3.2.4/dexie.min.js"></script>
    <style>
        .active-tab { border-bottom: 4px solid #2196F3; color: #2196F3; font-weight: bold; }
        .present-bg { background-color: #4CAF50 !important; color: white; }
        .absent-bg { background-color: #FF5722 !important; color: white; }
        #toast { visibility: hidden; min-width: 200px; background: #333; color: #fff; text-align: center; border-radius: 30px; padding: 10px; position: fixed; z-index: 100; left: 50%; bottom: 100px; transform: translateX(-50%); font-size: 14px; }
        #toast.show { visibility: visible; animation: fadein 0.5s, fadeout 0.5s 2.5s; }
        @keyframes fadein { from {bottom: 0; opacity: 0;} to {bottom: 100px; opacity: 1;} }
        @keyframes fadeout { from {bottom: 100px; opacity: 1;} to {bottom: 0; opacity: 0;} }
    </style>
</head>
<body class="bg-gray-100 pb-24">

    <header class="bg-[#2196F3] text-white p-4 shadow-lg sticky top-0 z-10">
        <div class="flex items-center gap-3 mb-3">
            <img src="icon.png" class="w-8 h-8 rounded-full bg-white">
            <h1 class="font-bold">SAT Attendance Pro</h1>
        </div>
        <input type="date" id="datePicker" class="p-2 rounded text-black w-full shadow-inner border-none">
    </header>

    <main class="p-4 max-w-2xl mx-auto">
        <section id="home-sec" class="tab-content">
            <div id="studentList" class="space-y-2"></div>
        </section>

        <section id="stats-sec" class="tab-content hidden">
            <div class="bg-white p-4 rounded-xl shadow-sm mb-4">
                <h3 class="font-bold text-gray-700 mb-2">Setup Monthly Holidays</h3>
                <div class="flex gap-2">
                    <input type="number" id="holidayCount" placeholder="Days" class="border p-2 rounded w-full" value="0">
                    <button onclick="saveHolidays()" class="bg-orange-500 text-white px-4 py-2 rounded font-bold text-sm">Save</button>
                </div>
                <p class="text-[10px] text-gray-400 mt-1 italic">* Sundays & holidays for the selected month.</p>
            </div>

            <div id="statsSummary" class="space-y-4"></div>
        </section>

        <section id="upload-sec" class="tab-content hidden">
            <div class="bg-white p-8 rounded-2xl shadow text-center">
                <input type="file" id="excelInput" class="hidden" accept=".xlsx, .xls">
                <label for="excelInput" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold cursor-pointer inline-block">Upload Student Excel</label>
            </div>
        </section>
    </main>

    <div id="toast">Attendance marked successfully!</div>

    <nav class="fixed bottom-0 w-full bg-white border-t flex justify-around py-3 shadow-2xl">
        <button onclick="showTab('home')" id="home-btn" class="flex flex-col items-center active-tab"><span>üìÖ</span><span class="text-[10px]">MARK</span></button>
        <button onclick="showTab('stats')" id="stats-btn" class="flex flex-col items-center"><span>üìà</span><span class="text-[10px]">REPORTS</span></button>
        <button onclick="showTab('upload')" id="upload-btn" class="flex flex-col items-center"><span>‚öôÔ∏è</span><span class="text-[10px]">SETUP</span></button>
    </nav>

    <script>
        const db = new Dexie("SAT_PRO_DB");
        db.version(2).stores({
            students: 'rollNo, name, gender',
            attendance: '++id, [rollNo+date], date, status',
            settings: 'key' // To store holiday counts per month
        });

        const datePicker = document.getElementById('datePicker');
        datePicker.valueAsDate = new Date();

        // Toast Message
        function showToast(msg) {
            const t = document.getElementById("toast");
            t.innerText = msg;
            t.className = "show";
            setTimeout(() => t.className = "", 3000);
        }

        // Attendance Logic
        async function loadAttendanceList() {
            const students = await db.students.toArray();
            const date = datePicker.value;
            const container = document.getElementById('studentList');
            container.innerHTML = '';

            for (let s of students) {
                const rec = await db.attendance.get({rollNo: s.rollNo, date: date});
                const div = document.createElement('div');
                div.className = "flex justify-between items-center p-3 bg-white rounded-lg shadow-sm border-l-4 mb-2 " + (s.gender === 'Male' ? 'border-blue-500' : 'border-pink-500');
                div.innerHTML = `
                    <div>
                        <div class="font-bold text-gray-800">${s.name}</div>
                        <div class="text-[10px] text-gray-400">Roll: ${s.rollNo}</div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="mark('${s.rollNo}', 'Present')" class="w-10 h-10 rounded border ${rec?.status === 'Present' ? 'present-bg' : 'bg-gray-50 text-gray-400'}">P</button>
                        <button onclick="mark('${s.rollNo}', 'Absent')" class="w-10 h-10 rounded border ${rec?.status === 'Absent' ? 'absent-bg' : 'bg-gray-100 text-gray-400'}">A</button>
                    </div>`;
                container.appendChild(div);
            }
        }

        async function mark(rollNo, status) {
            await db.attendance.put({rollNo, date: datePicker.value, status});
            showToast(`Marked ${rollNo} as ${status}`);
            loadAttendanceList();
        }

        // Holiday Management
        async function saveHolidays() {
            const monthKey = datePicker.value.substring(0, 7);
            const count = document.getElementById('holidayCount').value;
            await db.settings.put({key: monthKey, value: parseInt(count)});
            showToast("Holidays Updated!");
            calculateStats();
        }

        // Advanced Statistics Engine
        async function calculateStats() {
            const monthStr = datePicker.value.substring(0, 7);
            const [year, month] = monthStr.split('-').map(Number);
            const totalDaysInMonth = new Date(year, month, 0).getDate();
            
            const holidayData = await db.settings.get(monthStr);
            const holidays = holidayData ? holidayData.value : 0;
            const workingDays = totalDaysInMonth - holidays;
            document.getElementById('holidayCount').value = holidays;

            const students = await db.students.toArray();
            const attendance = await db.attendance.filter(a => a.date.startsWith(monthStr)).toArray();

            const boys = students.filter(s => s.gender === 'Male');
            const girls = students.filter(s => s.gender === 'Female');

            const getStats = (group) => {
                const rolls = group.map(s => s.rollNo);
                const records = attendance.filter(a => rolls.includes(a.rollNo));
                const presentCount = records.filter(a => a.status === 'Present').length;
                const totalPossibleEntries = group.length * workingDays;
                const percent = totalPossibleEntries > 0 ? ((presentCount / totalPossibleEntries) * 100).toFixed(1) : 0;
                const avg = group.length > 0 ? (presentCount / (group.length * workingDays)).toFixed(2) : 0;
                return { present: presentCount, percent, avg, total: group.length };
            };

            const b = getStats(boys);
            const g = getStats(girls);
            const totalPresent = b.present + g.present;
            const totalPossible = students.length * workingDays;
            const totalPercent = totalPossible > 0 ? ((totalPresent / totalPossible) * 100).toFixed(1) : 0;

            document.getElementById('statsSummary').innerHTML = `
                <div class="bg-gray-800 text-white p-5 rounded-2xl shadow-lg">
                    <p class="text-[10px] opacity-60 uppercase font-bold tracking-widest">Monthly Working Days: ${workingDays}</p>
                    <div class="mt-2 flex justify-between items-end">
                        <div>
                            <p class="text-xs opacity-80">Combined Present %</p>
                            <p class="text-4xl font-black text-blue-400">${totalPercent}%</p>
                        </div>
                        <div class="text-right">
                            <p class="text-xs opacity-80 font-bold">Total Present: ${totalPresent}</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                        <p class="font-bold text-blue-700 text-sm">BOYS REPORT</p>
                        <div class="mt-2 space-y-1 text-xs">
                            <p>Total Present: <b>${b.present}</b></p>
                            <p>Present %: <b class="text-lg">${b.percent}%</b></p>
                            <p>Avg Present: <b>${b.avg}</b></p>
                        </div>
                    </div>
                    <div class="bg-pink-50 p-4 rounded-xl border border-pink-100">
                        <p class="font-bold text-pink-700 text-sm">GIRLS REPORT</p>
                        <div class="mt-2 space-y-1 text-xs">
                            <p>Total Present: <b>${g.present}</b></p>
                            <p>Present %: <b class="text-lg">${g.percent}%</b></p>
                            <p>Avg Present: <b>${g.avg}</b></p>
                        </div>
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                    <p class="font-bold text-gray-700 mb-2">Overall Monthly Summary</p>
                    <div class="grid grid-cols-2 text-xs gap-y-2">
                        <span class="text-gray-500">Total Students:</span> <span class="text-right font-bold">${students.length}</span>
                        <span class="text-gray-500">Total Month Days:</span> <span class="text-right font-bold">${totalDaysInMonth}</span>
                        <span class="text-gray-500">Holiday Adjustment:</span> <span class="text-right font-bold text-orange-600">-${holidays}</span>
                        <div class="col-span-2 border-t mt-2 pt-2 flex justify-between font-bold text-blue-600">
                            <span>COMBINED AVERAGE:</span> <span>${((parseFloat(b.avg) + parseFloat(g.avg))/2).toFixed(2)}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        // Setup Logic
        function showTab(tab) {
            document.querySelectorAll('.tab-content').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-tab'));
            document.getElementById(tab + '-sec').classList.remove('hidden');
            document.getElementById(tab + '-btn').classList.add('active-tab');
            if(tab === 'stats') calculateStats();
            if(tab === 'home') loadAttendanceList();
        }

        document.getElementById('excelInput').onchange = async (e) => {
            const data = await e.target.files[0].arrayBuffer();
            const workbook = XLSX.read(data);
            const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]]);
            const students = json.map(r => ({ rollNo: String(r['Roll No'] || r['roll']), name: r['Student Name'] || r['name'], gender: r['Gender'] || 'Male' }));
            await db.students.bulkPut(students);
            showToast("Excel Data Imported!");
            showTab('home');
        };

        datePicker.onchange = loadAttendanceList;
        loadAttendanceList();
    </script>
</body>
</html>
